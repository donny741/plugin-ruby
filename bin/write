#!/usr/bin/env node

const fs = require("fs");
const net = require("net");

function parse(text) {
  const client = new net.Socket();

  return new Promise((resolve, reject) => {
    client.setTimeout(10 * 1000, () => {
      client.destroy();
      reject(new Error("Connection to the server timed out."));
    });

    client.on("error", (error) => {
      client.destroy();
      reject(error);
    });

    client.on("end", () => {
      client.destroy();
      reject(new Error("Server closed the connection."));
    });

    client.on("data", (data) => {
      client.destroy();
      resolve(JSON.parse(data.toString()));
    });

    client.connect({ port: 22020 }, () => {
      client.end(text);
    });
  });
}

parse(fs.readFileSync(0).toString())
  .then((ast) => {
    console.log(JSON.stringify(ast, ["type", "body", "comments"], 2));
  })
  .catch((error) => {
    console.log(`Error: ${error}`);
  });
